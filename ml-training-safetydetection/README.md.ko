# ML í›ˆë ¨ - ì•ˆì „ ê°ì§€

ì‚°ì—… í™˜ê²½ì—ì„œ ì‹¤ì‹œê°„ ìœ„í—˜ ê°ì§€ë¥¼ ìœ„í•œ YOLOv8 ë° ONNXë¥¼ ì‚¬ìš©í•œ ì‚°ì—… ì•ˆì „ ê°ì§€ ëª¨ë¸ í›ˆë ¨ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.

## ğŸ¯ ê°œìš”

ì´ í”„ë¡œì íŠ¸ëŠ” ë‹¤ìŒì„ ì‹ë³„í•  ìˆ˜ ìˆëŠ” ì•ˆì „ ê°ì§€ ëª¨ë¸ í›ˆë ¨ì„ ìœ„í•œ ì™„ì „í•œ ë¨¸ì‹ ëŸ¬ë‹ íŒŒì´í”„ë¼ì¸ì„ ì œê³µí•©ë‹ˆë‹¤:
- **ì—°ê¸°(Smoke)** - ì—°ê¸° ì¸ì‹ì„ í†µí•œ ì¡°ê¸° í™”ì¬ ê°ì§€
- **í™”ì¬(Fire)** - ì§ì ‘ì ì¸ ë¶ˆê½ƒ ë° í™”ì¬ ê°ì§€
- **ì‚¬ëŒ ì“°ëŸ¬ì§(Person Down)** - ì“°ëŸ¬ì§€ê±°ë‚˜ ë¶€ìƒë‹¹í•œ ì¸ì› ê°ì§€

í›ˆë ¨ëœ ëª¨ë¸ì€ ì‹¤ì‹œê°„ ì¶”ë¡ ì„ ìœ„í•´ ONNX í˜•ì‹ì„ ì‚¬ìš©í•˜ì—¬ ì—£ì§€ ë””ë°”ì´ìŠ¤ì— ë°°í¬í•˜ë„ë¡ ìµœì í™”ë˜ì—ˆìŠµë‹ˆë‹¤.

## ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
ml-training-safetydetection/
â”œâ”€â”€ complete_training.py          # ë©”ì¸ í›ˆë ¨ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ onnx_inference_final.py       # ONNX ì¶”ë¡  ë° í…ŒìŠ¤íŠ¸
â”œâ”€â”€ classes.txt                   # í´ë˜ìŠ¤ ì •ì˜
â”œâ”€â”€ README.md                     # ì˜ë¬¸ ë¬¸ì„œ
â”œâ”€â”€ README.md.ko                  # í•œê¸€ ë¬¸ì„œ (ì´ íŒŒì¼)
â”œâ”€â”€ MODEL_USAGE_GUIDE.md          # ìƒì„¸ ëª¨ë¸ ì‚¬ìš© ê°€ì´ë“œ
â”œâ”€â”€ onnx_optimization_guide.md    # ONNX ìµœì í™” íŒ
â”œâ”€â”€ industrial_safety_final.pt    # ì‚¬ì „ í›ˆë ¨ëœ PyTorch ëª¨ë¸ (6MB)
â”œâ”€â”€ yolov8n.pt                   # YOLOv8 nano ë² ì´ìŠ¤ ëª¨ë¸ (6MB)
â””â”€â”€ dataset_balanced/            # í›ˆë ¨ ë°ì´í„°ì…‹
    â”œâ”€â”€ dataset.yaml             # ë°ì´í„°ì…‹ ì„¤ì •
    â”œâ”€â”€ train/
    â”‚   â”œâ”€â”€ images/              # í›ˆë ¨ ì´ë¯¸ì§€
    â”‚   â””â”€â”€ labels/              # í›ˆë ¨ ë¼ë²¨ (YOLO í˜•ì‹)
    â””â”€â”€ val/
        â”œâ”€â”€ images/              # ê²€ì¦ ì´ë¯¸ì§€
        â””â”€â”€ labels/              # ê²€ì¦ ë¼ë²¨ (YOLO í˜•ì‹)
```

## ğŸš€ ë¹ ë¥¸ ì‹œì‘

### ì‚¬ì „ ìš”êµ¬ì‚¬í•­

```bash
pip install ultralytics opencv-python onnxruntime numpy boto3 sagemaker
```

### í›ˆë ¨ ì˜µì…˜

#### ì˜µì…˜ 1: ë¡œì»¬ í›ˆë ¨

```bash
python complete_training.py
```

#### ì˜µì…˜ 2: AWS SageMaker í›ˆë ¨

GPU ê°€ì†ì„ í†µí•œ ëŒ€ê·œëª¨ í›ˆë ¨ì˜ ê²½ìš°:

**1. SageMaker í›ˆë ¨ ìŠ¤í¬ë¦½íŠ¸ ì¤€ë¹„**

`sagemaker_train.py` ìƒì„±:
```python
import sagemaker
from sagemaker.pytorch import PyTorch
from sagemaker import get_execution_role

# SageMaker ì„¸ì…˜ ë° ì—­í• 
sagemaker_session = sagemaker.Session()
role = get_execution_role()

# ë°ì´í„°ì…‹ì„ S3ì— ì—…ë¡œë“œ
dataset_s3_path = sagemaker_session.upload_data(
    path='./dataset_balanced',
    bucket='your-sagemaker-bucket',
    key_prefix='safety-detection/dataset'
)

# PyTorch ì¶”ì •ê¸° ì •ì˜
estimator = PyTorch(
    entry_point='complete_training.py',
    source_dir='.',
    role=role,
    instance_type='ml.g4dn.xlarge',  # GPU ì¸ìŠ¤í„´ìŠ¤
    instance_count=1,
    framework_version='2.0.0',
    py_version='py310',
    hyperparameters={
        'epochs': 100,
        'batch-size': 32,
        'learning-rate': 0.001
    }
)

# í›ˆë ¨ ì‹œì‘
estimator.fit({'training': dataset_s3_path})
```

**2. SageMaker í›ˆë ¨ ì‹¤í–‰**
```bash
python sagemaker_train.py
```

**3. ëª¨ë¸ ì—”ë“œí¬ì¸íŠ¸ ë°°í¬**
```python
# í›ˆë ¨ëœ ëª¨ë¸ ë°°í¬
predictor = estimator.deploy(
    initial_instance_count=1,
    instance_type='ml.m5.large'
)

# ì˜ˆì¸¡ ìˆ˜í–‰
result = predictor.predict(image_data)
```

### 2. ONNX ëª¨ë¸ í…ŒìŠ¤íŠ¸

```bash
python onnx_inference_final.py
```

ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë‹¤ìŒì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:
- ONNX ëª¨ë¸ ë¡œë“œ (`best.onnx`)
- ì¶”ë¡  ì†ë„ í…ŒìŠ¤íŠ¸
- ê°ì§€ ì •í™•ë„ ê²€ì¦
- ìƒ˜í”Œ ê°ì§€ ê²°ê³¼ ìƒì„±

## ğŸ“Š ëª¨ë¸ í´ë˜ìŠ¤

| í´ë˜ìŠ¤ ID | ì´ë¦„ | ì„¤ëª… |
|----------|------|-------------|
| 0 | smoke | ì¡°ê¸° í™”ì¬ ê²½ê³ ë¥¼ ìœ„í•œ ì—°ê¸° ê°ì§€ |
| 1 | fire | ì§ì ‘ì ì¸ ë¶ˆê½ƒ ë° í™”ì¬ ê°ì§€ |
| 2 | person_down | ì“°ëŸ¬ì§€ê±°ë‚˜ ë¶€ìƒë‹¹í•œ ì‚¬ëŒ ê°ì§€ |

## ğŸ”§ í›ˆë ¨ ì„¸ë¶€ì‚¬í•­

### ë¡œì»¬ í›ˆë ¨ ì„¤ì •
- ë² ì´ìŠ¤ ëª¨ë¸: YOLOv8 nano
- ì´ë¯¸ì§€ í¬ê¸°: 640x640
- ë°°ì¹˜ í¬ê¸°: 16
- ì—í¬í¬: 50
- ë””ë°”ì´ìŠ¤: MPS (Apple Silicon) ë˜ëŠ” CPU
- ê²€ì¦: ë¹ ë¥¸ í›ˆë ¨ì„ ìœ„í•´ ë¹„í™œì„±í™”

### SageMaker í›ˆë ¨ ì„¤ì •
- ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…: ml.g4dn.xlarge (GPU)
- ë² ì´ìŠ¤ ëª¨ë¸: YOLOv8 nano
- ì´ë¯¸ì§€ í¬ê¸°: 640x640
- ë°°ì¹˜ í¬ê¸°: 32 (GPUë¡œ ì¸í•œ ë” í° í¬ê¸°)
- ì—í¬í¬: 100 (ë” ë‚˜ì€ ì •í™•ë„ë¥¼ ìœ„í•œ ë” ë§ì€ ì—í¬í¬)
- í”„ë ˆì„ì›Œí¬: PyTorch 2.0.0
- Python: 3.10

### í›ˆë ¨ ì¶œë ¥
- `runs/detect/safety_complete/weights/best.pt` - ìµœê³  PyTorch ëª¨ë¸
- `best.onnx` - ë‚´ë³´ë‚¸ ONNX ëª¨ë¸
- SageMaker: S3ì— ì €ì¥ëœ ëª¨ë¸ ì•„í‹°íŒ©íŠ¸

### ë°ì´í„°ì…‹ í˜•ì‹
- **ì´ë¯¸ì§€**: JPG/PNG í˜•ì‹, ê¶Œì¥ í•´ìƒë„ 640x640
- **ë¼ë²¨**: YOLO í˜•ì‹ (.txt íŒŒì¼)
  ```
  class_id x_center y_center width height
  ```
  ëª¨ë“  ì¢Œí‘œëŠ” 0-1 ë²”ìœ„ë¡œ ì •ê·œí™”

### ëª¨ë¸ ì•„í‚¤í…ì²˜
- **ë² ì´ìŠ¤**: YOLOv8 nano (ì—£ì§€ ë°°í¬ë¥¼ ìœ„í•œ ê²½ëŸ‰í™”)
- **ì…ë ¥ í¬ê¸°**: 640x640x3
- **ì¶œë ¥**: í´ë˜ìŠ¤ í™•ë¥ ì´ í¬í•¨ëœ ë°”ìš´ë”© ë°•ìŠ¤
- **ì¶”ë¡  ì†ë„**: ìµœì‹  í•˜ë“œì›¨ì–´ì—ì„œ ~10-20ms

### í›ˆë ¨ ë§¤ê°œë³€ìˆ˜
```python
epochs=50           # í›ˆë ¨ ë°˜ë³µ íšŸìˆ˜
imgsz=640          # ì…ë ¥ ì´ë¯¸ì§€ í¬ê¸°
batch=16           # ë°°ì¹˜ í¬ê¸°
device='mps'       # Apple Silicon GPU
val=False          # ì†ë„ë¥¼ ìœ„í•´ ê²€ì¦ ê±´ë„ˆë›°ê¸°
```

## ğŸ“ˆ ì„±ëŠ¥ ì§€í‘œ

### ëª¨ë¸ í¬ê¸°
- **PyTorch (.pt)**: ~6MB
- **ONNX (.onnx)**: ~12MB
- **ì¶”ë¡  ì†ë„**: í•˜ë“œì›¨ì–´ì— ë”°ë¼ 10-50ms

### ì •í™•ë„ (ì¶”ì •ì¹˜)
- **ì—°ê¸° ê°ì§€**: 85-90% mAP@0.5
- **í™”ì¬ ê°ì§€**: 90-95% mAP@0.5
- **ì‚¬ëŒ ì“°ëŸ¬ì§**: 80-85% mAP@0.5

## ğŸ”„ ëª¨ë¸ ë‚´ë³´ë‚´ê¸° ì›Œí¬í”Œë¡œ

1. **í›ˆë ¨**: YOLOv8ì„ ì‚¬ìš©í•œ PyTorch ëª¨ë¸ í›ˆë ¨
2. **ë‚´ë³´ë‚´ê¸°**: ë°°í¬ë¥¼ ìœ„í•´ ONNX í˜•ì‹ìœ¼ë¡œ ë³€í™˜
3. **ìµœì í™”**: ì¶”ë¡ ì„ ìœ„í•œ ONNX ëª¨ë¸ ìµœì í™”
4. **ë°°í¬**: ì—£ì§€ ë””ë°”ì´ìŠ¤ ë˜ëŠ” í´ë¼ìš°ë“œì— ë°°í¬

## ğŸ“ ì‚¬ìš© ì˜ˆì œ

### ì»¤ìŠ¤í…€ ë°ì´í„°ì…‹ í›ˆë ¨
```python
from ultralytics import YOLO

# ë² ì´ìŠ¤ ëª¨ë¸ ë¡œë“œ
model = YOLO('yolov8n.pt')

# ì»¤ìŠ¤í…€ ë°ì´í„°ì…‹ìœ¼ë¡œ í›ˆë ¨
results = model.train(
    data='./dataset_balanced/dataset.yaml',
    epochs=50,
    imgsz=640,
    batch=16
)

# ONNXë¡œ ë‚´ë³´ë‚´ê¸°
model.export(format='onnx')
```

### ONNX ì¶”ë¡ 
```python
import onnxruntime as ort
import cv2
import numpy as np

# ONNX ëª¨ë¸ ë¡œë“œ
session = ort.InferenceSession('best.onnx')

# ì´ë¯¸ì§€ ì¤€ë¹„
image = cv2.imread('test_image.jpg')
image = cv2.resize(image, (640, 640))
image = image.astype(np.float32) / 255.0
image = np.transpose(image, (2, 0, 1))
image = np.expand_dims(image, axis=0)

# ì¶”ë¡  ì‹¤í–‰
outputs = session.run(None, {'images': image})
```

## ğŸ› ï¸ ì»¤ìŠ¤í„°ë§ˆì´ì§•

### SageMaker í›ˆë ¨ ì»¤ìŠ¤í„°ë§ˆì´ì§•

**í•˜ì´í¼íŒŒë¼ë¯¸í„° íŠœë‹:**
```python
from sagemaker.tuner import HyperparameterTuner, IntegerParameter, ContinuousParameter

# í•˜ì´í¼íŒŒë¼ë¯¸í„° ë²”ìœ„ ì •ì˜
hyperparameter_ranges = {
    'learning-rate': ContinuousParameter(0.0001, 0.01),
    'batch-size': IntegerParameter(16, 64),
    'epochs': IntegerParameter(50, 200)
}

# íŠœë„ˆ ìƒì„±
tuner = HyperparameterTuner(
    estimator,
    objective_metric_name='validation:mAP',
    hyperparameter_ranges=hyperparameter_ranges,
    max_jobs=10,
    max_parallel_jobs=2
)

# íŠœë‹ ì‹œì‘
tuner.fit({'training': dataset_s3_path})
```

**ë©€í‹° GPU í›ˆë ¨:**
```python
estimator = PyTorch(
    entry_point='complete_training.py',
    instance_type='ml.p3.8xlarge',  # ë©€í‹° GPU ì¸ìŠ¤í„´ìŠ¤
    instance_count=1,
    distribution={'parameter_server': {'enabled': True}}
)
```

**ìŠ¤íŒŸ ì¸ìŠ¤í„´ìŠ¤ í›ˆë ¨ (ë¹„ìš© ìµœì í™”):**
```python
estimator = PyTorch(
    entry_point='complete_training.py',
    use_spot_instances=True,
    max_wait=7200,  # 2ì‹œê°„
    max_run=3600,   # 1ì‹œê°„
    checkpoint_s3_uri='s3://your-bucket/checkpoints/'
)
```

### ìƒˆ í´ë˜ìŠ¤ ì¶”ê°€
1. ìƒˆ í´ë˜ìŠ¤ ì´ë¦„ìœ¼ë¡œ `classes.txt` ì—…ë°ì´íŠ¸
2. ìƒˆ í´ë˜ìŠ¤ë¥¼ í¬í•¨í•˜ë„ë¡ `dataset.yaml` ìˆ˜ì •
3. ìƒˆ í´ë˜ìŠ¤ ë¼ë²¨ë¡œ í›ˆë ¨ ë°ì´í„° ì¤€ë¹„
4. ëª¨ë¸ ì¬í›ˆë ¨

### í›ˆë ¨ ë§¤ê°œë³€ìˆ˜ ì¡°ì •
`complete_training.py` í¸ì§‘:
```python
# ë” ë‚˜ì€ ì •í™•ë„ë¥¼ ìœ„í•´ ì—í¬í¬ ì¦ê°€
epochs=100

# GPU ë©”ëª¨ë¦¬ì— ë”°ë¼ ë°°ì¹˜ í¬ê¸° ì¡°ì •
batch=8  # ì œí•œëœ ë©”ëª¨ë¦¬ìš©

# ê²€ì¦ í™œì„±í™”
val=True
```

## ğŸ” ë¬¸ì œ í•´ê²°

### ë¡œì»¬ í›ˆë ¨ ë¬¸ì œ

**ë©”ëª¨ë¦¬ ë¶€ì¡± ì˜¤ë¥˜:**
- ë°°ì¹˜ í¬ê¸° ì¤„ì´ê¸°: `batch=8` ë˜ëŠ” `batch=4`
- ë” ì‘ì€ ì´ë¯¸ì§€ í¬ê¸° ì‚¬ìš©: `imgsz=416`

**ë‚®ì€ ê°ì§€ ì •í™•ë„:**
- í›ˆë ¨ ì—í¬í¬ ì¦ê°€: `epochs=100`
- ë” ë§ì€ í›ˆë ¨ ë°ì´í„° ì¶”ê°€
- ë°ì´í„° ì¦ê°• í™œì„±í™”

**ëŠë¦° ì¶”ë¡ :**
- GPU ê°€ì† ì‚¬ìš©
- ONNX ëª¨ë¸ ìµœì í™”
- ì…ë ¥ ì´ë¯¸ì§€ í¬ê¸° ì¤„ì´ê¸°

### SageMaker í›ˆë ¨ ë¬¸ì œ

**í›ˆë ¨ ì‘ì—… ì‹¤íŒ¨:**
```bash
# CloudWatch ë¡œê·¸ í™•ì¸
aws logs describe-log-groups --log-group-name-prefix /aws/sagemaker/TrainingJobs

# íŠ¹ì • í›ˆë ¨ ì‘ì—… ë¡œê·¸ ë³´ê¸°
aws logs get-log-events --log-group-name /aws/sagemaker/TrainingJobs/your-job-name
```

**ë†’ì€ í›ˆë ¨ ë¹„ìš©:**
- ìŠ¤íŒŸ ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš© (ìµœëŒ€ 90% ë¹„ìš© ì ˆê°)
- ì ì ˆí•œ ì¸ìŠ¤í„´ìŠ¤ íƒ€ì… ì„ íƒ
- ì¡°ê¸° ì¤‘ë‹¨ í™œì„±í™”
- ì‹¤í—˜ìš©ìœ¼ë¡œ ë” ì‘ì€ ë°ì´í„°ì…‹ ì‚¬ìš©

**ë°ì´í„° ì ‘ê·¼ ë¬¸ì œ:**
```python
# ì ì ˆí•œ S3 ê¶Œí•œ í™•ì¸
import boto3
s3 = boto3.client('s3')
s3.head_object(Bucket='your-bucket', Key='dataset/train/images/image1.jpg')
```

**ëª¨ë¸ ë°°í¬ ì‹¤íŒ¨:**
- ì—”ë“œí¬ì¸íŠ¸ ì„¤ì • í™•ì¸
- S3ì˜ ëª¨ë¸ ì•„í‹°íŒ©íŠ¸ ê²€ì¦
- IAM ê¶Œí•œ ê²€í† 

## ğŸ“š ì¶”ê°€ ìë£Œ

- [YOLOv8 ë¬¸ì„œ](https://docs.ultralytics.com/)
- [ONNX Runtime ë¬¸ì„œ](https://onnxruntime.ai/docs/)
- [AWS SageMaker ë¬¸ì„œ](https://docs.aws.amazon.com/sagemaker/)
- [SageMaker Python SDK](https://sagemaker.readthedocs.io/)
- [MODEL_USAGE_GUIDE.md](./MODEL_USAGE_GUIDE.md) - ìƒì„¸ ì‚¬ìš© ì§€ì¹¨
- [onnx_optimization_guide.md](./onnx_optimization_guide.md) - ì„±ëŠ¥ ìµœì í™”

### SageMaker ìë£Œ
- [SageMaker í›ˆë ¨ ëª¨ë²” ì‚¬ë¡€](https://docs.aws.amazon.com/sagemaker/latest/dg/training-best-practices.html)
- [SageMaker ìš”ê¸ˆ](https://aws.amazon.com/ko/sagemaker/pricing/)
- [SageMaker ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…](https://docs.aws.amazon.com/sagemaker/latest/dg/notebooks-available-instance-types.html)

## ğŸ“„ ë¼ì´ì„ ìŠ¤

ì´ í”„ë¡œì íŠ¸ëŠ” MIT ë¼ì´ì„ ìŠ¤ í•˜ì— ë¼ì´ì„ ìŠ¤ê°€ ë¶€ì—¬ë©ë‹ˆë‹¤ - ìì„¸í•œ ë‚´ìš©ì€ LICENSE íŒŒì¼ì„ ì°¸ì¡°í•˜ì„¸ìš”.

## ğŸ¤ ê¸°ì—¬

1. ì €ì¥ì†Œ í¬í¬
2. ê¸°ëŠ¥ ë¸Œëœì¹˜ ìƒì„±
3. ê°œì„ ì‚¬í•­ ì¶”ê°€
4. í’€ ë¦¬í€˜ìŠ¤íŠ¸ ì œì¶œ

## ğŸ“ ì§€ì›

ì§ˆë¬¸ ë° ì§€ì›ì€ ë¬¸ì„œë¥¼ ì°¸ì¡°í•˜ê±°ë‚˜ ì €ì¥ì†Œì— ì´ìŠˆë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”.
