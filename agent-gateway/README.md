# ğŸŒ AgentCore Gateway - MCP Server

> **Robot Control Command Delivery System via Model Context Protocol (MCP)**

<p>
  | <a href="./README.md">English</a> | <a href="./README-ko.md">í•œêµ­ì–´</a> |
</p>

This component implements an MCP server that converts natural language commands into robot control signals using Amazon Bedrock AgentCore Gateway and Lambda. It serves as a core interface that transforms commands generated by AI agents into actual robot actions.

## ğŸ¯ Key Features

### ğŸ¤– Robot Control Command Conversion
- Converts natural language commands into structured robot control signals
- Supports Action and Message-based command structures
- Real-time command processing and response

### ğŸ”— MCP Protocol Support
- Complies with Model Context Protocol standards
- Perfect integration with Bedrock AgentCore
- Extensible tool interface

### ğŸ›¡ï¸ Security and Authentication
- AWS Cognito-based JWT authentication
- Secure permission management through IAM roles
- Custom JWT Authorizer support

## ğŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AI Agent      â”‚â”€â”€â”€â–¶â”‚  AgentCore       â”‚â”€â”€â”€â–¶â”‚   Lambda        â”‚
â”‚  (Bedrock)      â”‚    â”‚   Gateway        â”‚    â”‚   Function      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                        â”‚
                                â–¼                        â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   MCP Server     â”‚    â”‚   Robot         â”‚
                       â”‚   (Tool Spec)    â”‚    â”‚   Controller    â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ MCP Interface Tool Spec

Robot control commands consist of `action` and `message`. Currently support 4 basic emotional state actions for the robot.

### Tool Schema Definition

```json
{
    "name": "command",
    "description": "You are a robot controller. Commands to control the robot are action and message. Pass the appropriate robot action name as action and the message the robot will deliver as message. Choose one of HAPPY, NEUTRAL, SAD, ANGRY for action.",
    "inputSchema": {
        "type": "object",
        "properties": {
            "action": {
                "type": "string",
                "description": "Robot action command (HAPPY, NEUTRAL, SAD, ANGRY)"
            },
            "message": {
                "type": "string",
                "description": "Message for the robot to deliver (optional)"
            }
        },
        "required": ["action"]
    }
}
```

## âš™ï¸ MCP Server Implementation

### Lambda Function Handler

The core of the MCP server is implemented in the Lambda function. It extracts the tool name from the received event and converts action and message into robot control commands.

```python
def lambda_handler(event, context):
    # Extract tool name passed from Bedrock AgentCore
    toolName = context.client_context.custom['bedrockAgentCoreToolName']
    
    # Extract actual command from tool name (target_name___command format)
    delimiter = "___"
    if delimiter in toolName:
        toolName = toolName[toolName.index(delimiter) + len(delimiter):]

    # Extract action and message from event
    action = event.get('action')
    message = event.get('message')

    # Execute robot control for command tool
    if toolName == 'command':
        result = command_robot(action, message)
        return {
            'statusCode': 200, 
            'body': result
        }
```

### Robot Control Function

```python
def command_robot(action, message):
    """Function to execute robot control commands"""
    try:
        # Implement robot control logic
        robot_response = {
            "status": "success",
            "action": action,
            "message": message,
            "timestamp": datetime.now().isoformat(),
            "robot_id": "robo-dog-001"
        }
        
        # Actual robot control API call (example)
        # robot_client.send_command(action, message)
        
        return robot_response
    except Exception as e:
        return {
            "status": "error",
            "error": str(e),
            "action": action,
            "message": message
        }
```

## ğŸš€ Deployment and Setup

### 1. Create IAM Roles

First, create the necessary IAM roles:

```bash
python create_gateway_role.py
```

This script creates the following roles:
- AgentCore Gateway execution role
- Lambda function execution role
- Required permission policy attachments

### 2. Deploy Gateway and Target

Create Gateway and Target, and deploy Lambda function:

```bash
python create_gateway_tool.py
```

This process creates:
- AgentCore Gateway instance
- Lambda function (MCP server)
- Gateway Target connection
- Cognito authentication setup

### 3. Gateway Creation Details

```python
# Create Gateway
gateway_id = config.get('gateway_id')    
gateway_url = f'https://{gateway_id}.gateway.bedrock-agentcore.{region}.amazonaws.com/mcp'
agentcore_gateway_iam_role = config['agentcore_gateway_iam_role']

# Cognito JWT authentication setup
auth_config = {
    "customJWTAuthorizer": { 
        "allowedClients": [client_id],  
        "discoveryUrl": cognito_discovery_url
    }
}

# Create Gateway
response = gateway_client.create_gateway(
    name=gateway_name,
    roleArn=agentcore_gateway_iam_role,
    protocolType='MCP',
    authorizerType='CUSTOM_JWT',
    authorizerConfiguration=auth_config, 
    description=f'AgentCore Gateway for {projectName}'
)
```

### 4. Target Deployment

```python
# Load Tool Spec
TOOL_SPEC = json.load(open(os.path.join(script_dir, "tool_spec.json")))

# Lambda Target configuration
lambda_target_config = {
    "mcp": {
        "lambda": {
            "lambdaArn": lambda_function_arn, 
            "toolSchema": {
                "inlinePayload": [TOOL_SPEC]
            }
        }
    }
}

# Credential configuration
credential_config = [ 
    {
        "credentialProviderType": "GATEWAY_IAM_ROLE"
    }
]

# Create Target
response = gateway_client.create_gateway_target(
    gatewayIdentifier=gateway_id,
    name=targetname,
    description=f'{targetname} for {projectName}',
    targetConfiguration=lambda_target_config,
    credentialProviderConfigurations=credential_config
)

target_id = response["targetId"]
```

## ğŸ”§ Usage

### MCP Client Connection

```python
from mcp.client.streamable_http import streamablehttp_client

# Connect to MCP server
async with streamablehttp_client(mcp_url, headers, timeout=120, terminate_on_close=False) as (
    read_stream, write_stream, _):

    async with ClientSession(read_stream, write_stream) as session:
        # Get available tools list
        tool_result = await asyncio.wait_for(session.list_tools(), timeout=60)
        for tool in tool_result.tools:
            print(f"  - {tool.name}: {tool.description[:100]}...")

        # Execute robot control command
        target_name = config['target_name']
        tool_name = f"{target_name}___command"
        params = {
            "action": "HAPPY",
            "message": "Hello! Have a great day!"
        }
        
        result = await asyncio.wait_for(
            session.call_tool(tool_name, params), 
            timeout=30
        )
        print(f"Robot control result: {result}")
```

### MCP Server Configuration

```python
# Generate MCP server connection information
gateway_url = f'https://{gateway_id}.gateway.bedrock-agentcore.{region}.amazonaws.com/mcp'
bearer_token = retrieve_bearer_token(config['secret_name'])

mcp_config = {
    "mcpServers": {
        "agentcore-gateway": {
            "type": "streamable_http",
            "url": gateway_url,
            "headers": {
                "Authorization": f"Bearer {bearer_token}",
                "Content-Type": "application/json",
                "Accept": "application/json, text/event-stream"
            }
        }
    }
}
```

## ğŸ§ª Testing

### Remote MCP Server Test

```bash
python test_mcp_remote.py
```

This test verifies:
- MCP server connection status
- Available tools list
- Robot control command execution
- Response time and error handling

### Test Result Example

```
ğŸ”§ MCP Server Connection Test
âœ… Connection successful: https://abc123.gateway.bedrock-agentcore.us-west-2.amazonaws.com/mcp

ğŸ“‹ Available tools:
  - command: You are a robot controller...

ğŸ¤– Robot Control Test:
  Action: HAPPY
  Message: Test message
  Result: {"status": "success", "action": "HAPPY", ...}
```

## ğŸ“š Additional Resources

- [Amazon Bedrock AgentCore Documentation](https://docs.aws.amazon.com/bedrock/latest/userguide/agents.html)
- [Model Context Protocol (MCP) Specification](https://modelcontextprotocol.io/)
- [AWS Lambda Function Development Guide](https://docs.aws.amazon.com/lambda/latest/dg/python-programming-model.html)
