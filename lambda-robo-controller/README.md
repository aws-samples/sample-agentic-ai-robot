# 🤖 Direct Robot Control System

> **Lambda-based Robot Control Command Execution Engine**

<p>
  | <a href="./README.md">English</a> | <a href="./README-ko.md">한국어</a> |
</p>

This component is a Lambda function that directly executes robot control commands generated by AI agents or users. It serves as a backup system that can control robots directly without going through MCP servers, used in emergency situations or when direct control is needed.

## 🎯 Key Features

### 🚀 Direct Robot Control
- **Immediate Execution**: Instant robot control through Lambda function
- **Action-Message Structure**: Support for standardized command format
- **Various Actions**: Emotional expression actions like HAPPY, NEUTRAL, SAD, ANGRY
- **Emergency Response**: Fast robot control in emergency situations

### 🔧 Command Processing
- **JSON Payload**: Processing structured command data
- **Error Handling**: Appropriate error response when command execution fails
- **Logging**: Detailed logging of all command executions
- **Status Return**: Command execution results and robot status information return

### 📊 Monitoring and Debugging
- **Execution Logs**: Detailed execution logs through CloudWatch
- **Metric Collection**: Collection of command execution count, success rate, etc.
- **Debugging Support**: Debugging information for development and testing
- **Performance Monitoring**: Monitoring execution time and resource usage

## 🏗️ System Architecture

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Client        │───▶│   Lambda         │───▶│   Robot          │
│  (Direct Call)  │    │   Function       │    │   Hardware       │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
                       ┌──────────────────┐    ┌─────────────────┐
                       │   CloudWatch     │    │   Feedback       │
                       │   (Logs/Metrics) │    │   System        │
                       └──────────────────┘    └─────────────────┘
```

## 📋 Supported Robot Commands

### Basic Action Commands
| Action | Description | Usage Example |
|--------|-------------|---------------|
| `탐지` or `detected` | Detection state expression | "I detected an object" |
| `normal` | Normal state expression | "Performing routine tasks" |
| `stand` | Standing action | "Stand up" |
| `sit` | Sitting action | "Sit down" |
| `hello` | Greeting action | "Hello!" |
| `stretch` | Stretching action | "Stretch your body" |
| `scrape` | Scratching action | "Scratch" |
| `heart` | Heart expression action | "I love you" |
| `dance1` | First dance | "Dance" |
| `dance2` | Second dance | "Another dance" |
| `stop_move` | Stop movement | "Stop moving" |

### Movement Commands
| Action | Description | Usage Example |
|--------|-------------|---------------|
| `from1to2` | Move from position 1 to position 2 | "Moving to position 2" |
| `from2to0` | Move from position 2 to position 0 | "Moving to position 0" |
| `from0to1` | Move from position 0 to position 1 | "Moving to position 1" |

### Custom Commands
- **Other actions**: Actions not defined in code are passed through as-is for robot processing.

## ⚙️ Installation and Setup

### 1. Create AWS Resources

```bash
# Install robot controller
python create_robo_controller.py
```

This script creates the following AWS resources:
- Lambda function (`lambda-robo-controller-for-robo`)
- Required IAM roles and policies
- CloudWatch log group
- Environment variable configuration

### 2. Lambda Function Configuration

```python
# Create Lambda function
lambda_function_name = 'lambda-' + current_folder_name + '-for-' + config['projectName']

# Package function code
with zipfile.ZipFile(lambda_function_zip_path, 'w', zipfile.ZIP_DEFLATED) as zip_file:            
    for root, dirs, files in os.walk(lambda_dir):
        for file in files:
            file_path = os.path.join(root, file)
            arcname = os.path.relpath(file_path, lambda_dir)
            zip_file.write(file_path, arcname)

response = lambda_client.create_function(
    FunctionName=lambda_function_name,
    Runtime='python3.13',
    Handler='lambda_function.lambda_handler',
    Role=lambda_function_role,
    Description=f'Lambda function for {lambda_function_name}',
    Timeout=60,
    Code={
        'ZipFile': open(lambda_function_zip_path, 'rb').read()
    }
)
```

### 3. Environment Variable Configuration

```python
# Environment variable configuration
lambda_client.update_function_configuration(
    FunctionName=lambda_function_name,
    Environment={
        'Variables': {
            'TOPIC': 'robot/control'  # MQTT topic configuration
        }
    }
)
```

**Environment Variables Used:**
- `TOPIC`: MQTT topic name (default: 'robot/control')

## 🔧 Lambda Function Implementation

### Core Processing Logic

```python
import json
import boto3
import logging
from datetime import datetime

# Logging configuration
logger = logging.getLogger()
logger.setLevel(logging.INFO)

def lambda_handler(event, context):
    """Lambda function to process robot control commands"""
    
    try:
        # Input data validation
        action = event.get('action')
        message = event.get('message', '')
        
        if not action:
            return {
                'statusCode': 400,
                'body': json.dumps({
                    'error': 'Action is required',
                    'timestamp': datetime.now().isoformat()
                })
            }
        
        # Execute robot control command
        result = execute_robot_command(action, message)
        
        # Return success response
        return {
            'statusCode': 200,
            'body': json.dumps({
                'status': 'success',
                'action': action,
                'message': message,
                'result': result,
                'timestamp': datetime.now().isoformat(),
                'request_id': context.aws_request_id
            })
        }
        
    except Exception as e:
        logger.error(f"Error processing robot command: {str(e)}")
        return {
            'statusCode': 500,
            'body': json.dumps({
                'status': 'error',
                'error': str(e),
                'timestamp': datetime.now().isoformat(),
                'request_id': context.aws_request_id
            })
        }

def execute_robot_command(action, message):
    """Function to execute actual robot control commands"""
    
    # List of supported actions
    supported_actions = ['탐지', 'detected', 'from1to2', 'from2to0', 'from0to1', 'normal', 'stop_move', 'stand', 'sit', 'hello', 'stretch', 'scrape', 'heart', 'dance1', 'dance2']
    
    if action not in supported_actions:
        raise ValueError(f"Unsupported action: {action}")
    
    # Implement robot control logic
    robot_response = {
        "action_executed": action,
        "message_delivered": message,
        "robot_status": "active",
        "execution_time": datetime.now().isoformat(),
        "battery_level": 85.0,  # Value to be retrieved from actual robot
        "location": {
            "x": 10.5,
            "y": 20.3,
            "z": 0.0
        }
    }
    
    # Actual robot hardware control (example)
    # robot_client = RobotClient()
    # robot_client.send_command(action, message)
    
    logger.info(f"Robot command executed: {action} - {message}")
    
    return robot_response
```

## 🔧 Usage

### 1. Direct Lambda Invocation

```python
import boto3
import json

def test_robo_controller(lambda_function_name, action, message):
    """Test robot controller Lambda function"""
    
    # Configure payload
    payload = {
        'action': action,
        'message': message
    }
    
    print(f"Payload: {payload}")
    
    # Create Lambda client
    lambda_client = boto3.client(
        service_name='lambda',
        region_name='us-west-2'
    )
    
    try:
        # Invoke Lambda function
        response = lambda_client.invoke(
            FunctionName=lambda_function_name,
            Payload=json.dumps(payload),
            InvocationType='RequestResponse'  # Synchronous invocation
        )
        
        # Process response
        response_payload = json.loads(response['Payload'].read())
        print(f"Response: {response_payload}")
        
        return response_payload
        
    except Exception as e:
        print(f"Error occurred: {str(e)}")
        return None

# Usage example
action = 'hello'
message = 'Hello!'
result = test_robo_controller('lambda-robo-controller-for-robo', action, message)
```

### 2. Asynchronous Invocation

```python
# Asynchronous invocation (Fire and Forget)
response = lambda_client.invoke(
    FunctionName=lambda_function_name,
    Payload=json.dumps(payload),
    InvocationType='Event'  # Asynchronous invocation
)
```

### 3. Batch Processing

```python
# Process multiple commands in batch
commands = [
    {'action': 'hello', 'message': 'First greeting'},
    {'action': 'stand', 'message': 'Second standing'},
    {'action': 'dance1', 'message': 'Third dance'}
]

for command in commands:
    result = test_robo_controller(lambda_function_name, 
                                 command['action'], 
                                 command['message'])
    print(f"Command execution result: {result}")
```

## 🧪 Testing

### 1. Basic Functionality Test

```bash
# Test robot controller
python test_robot_controller.py
```

### 2. Test Scenarios

```python
def run_test_scenarios():
    """Execute various test scenarios"""
    
    test_cases = [
        {
            'name': 'Basic action test',
            'action': 'hello',
            'message': 'Test message'
        },
        {
            'name': 'Long message test',
            'action': 'stand',
            'message': 'This is a very long test message. Check if the robot can properly handle long messages.'
        },
        {
            'name': 'Special character test',
            'action': 'dance1',
            'message': 'Special characters: !@#$%^&*()_+-=[]{}|;:,.<>?'
        },
        {
            'name': 'Korean message test',
            'action': 'heart',
            'message': 'Korean message test. Check if the robot can properly handle Korean.'
        },
        {
            'name': 'Movement command test',
            'action': 'from1to2',
            'message': 'Position movement test.'
        }
    ]
    
    for test_case in test_cases:
        print(f"\n🧪 {test_case['name']}")
        result = test_robo_controller(
            'lambda-robo-controller-for-robo',
            test_case['action'],
            test_case['message']
        )
        
        if result and result.get('statusCode') == 200:
            print("✅ Test successful")
        else:
            print("❌ Test failed")

# Execute tests
run_test_scenarios()
```

### 3. Test Result Example

```
🤖 Robot Controller Test Started
✅ Lambda function connection successful: lambda-robo-controller-for-robo

🧪 Basic action test
Payload: {'action': 'hello', 'message': 'Test message'}
Response: {
  "statusCode": 200,
  "body": "{\"status\": \"success\", \"action\": \"hello\", \"message\": \"Test message\", \"result\": {...}}"
}
✅ Test successful

🧪 Long message test
Payload: {'action': 'stand', 'message': 'This is a very long test message...'}
Response: {...}
✅ Test successful
```

## 📊 Monitoring and Logging

### CloudWatch Logs

```python
# Log message example
{
    "timestamp": "2024-01-01T00:00:00Z",
    "level": "INFO",
    "message": "Robot command executed: hello - Hello!",
    "request_id": "abc123-def456-ghi789",
    "action": "hello",
    "message_length": 12,
    "execution_time_ms": 150
}
```

### Metric Collection

```python
# Send CloudWatch metrics
cloudwatch = boto3.client('cloudwatch')

cloudwatch.put_metric_data(
    Namespace='RobotController',
    MetricData=[
        {
            'MetricName': 'CommandsExecuted',
            'Value': 1,
            'Unit': 'Count',
            'Dimensions': [
                {
                    'Name': 'Action',
                    'Value': action
                }
            ]
        },
        {
            'MetricName': 'ExecutionTime',
            'Value': execution_time_ms,
            'Unit': 'Milliseconds'
        }
    ]
)
```

## 📚 Additional Resources

- [AWS Lambda Function Development Guide](https://docs.aws.amazon.com/lambda/latest/dg/python-programming-model.html)
- [CloudWatch Logging Guide](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/)
- [Lambda Monitoring Guide](https://docs.aws.amazon.com/lambda/latest/dg/monitoring-functions.html)